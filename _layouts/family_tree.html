<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ page.title }}</title>
  <link rel="stylesheet" href="{{ '/assets/css/familyTree.css' | relative_url }}">
  <script src="{{ "/assets/js/libs/FamilyTree.js" | relative_url }}"></script>
  <!-- Th√™m font ch·ªØ H√°n N√¥m -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Intro Animation -->
  <div id="introOverlay" class="intro-overlay">
    <h1 class="intro-title">{{ page.title }}</h1>
    <h2 class="intro-subtitle">{{ page.subtitle }}</h2>
    
    <!-- C√¢u ƒë·ªëi trong intro -->
    <div class="intro-couplets">
      <div class="intro-parallel-couplet intro-left-couplet">
        <div class="intro-couplet-text">
          <p class="chinese">{{ page.left_couplet_chinese }}</p>
        </div>
      </div>

      <div class="intro-parallel-couplet intro-right-couplet">
        <div class="intro-couplet-text">
          <p class="chinese">{{ page.right_couplet_chinese }}</p>
        </div>
      </div>
    </div>

    <div class="intro-incense">
      <div class="intro-incense-stick"></div>
      <div class="intro-incense-stick"></div>
      <div class="intro-incense-stick"></div>
    </div>
    <button id="enterButton" class="intro-button">Xem Gia Ph·∫£</button>
  </div>

  <!-- Khung t·ª´ ƒë∆∞·ªùng v·ªõi ho√†nh phi v√† c√¢u ƒë·ªëi -->
  <div id="ancestralAltar" class="ancestral-altar">
    <!-- Ho√†nh phi ph√≠a tr√™n -->
    <div class="horizontal-tablet">
      <div class="tablet-content">
        <span class="chinese-text">{{ page.subtitle }}</span>
        <span class="vietnamese-text">{{ page.title }}</span>
      </div>
      <div class="tablet-decoration"></div>
    </div>

    <!-- B√†n th·ªù ch√≠nh -->
    <div class="main-altar">
        <!-- Container ch√≠nh cho c√¢y gia ph·∫£ -->
        <div class="tree-container">
          <!-- C√¢y gia ph·∫£ ƒë∆∞·ª£c ƒë·∫∑t trong khung b√†i v·ªã -->
          <div class="memorial-tablet">
            <div id="tree"></div>
          </div>

          <!-- C√°c n√∫t ch·ª©c nƒÉng ƒë∆∞·ª£c thi·∫øt k·∫ø nh∆∞ v·∫≠t ph·∫©m th·ªù c√∫ng -->
          <div class="ritual-tools">
            <button id="debugBtn" class="ritual-btn" title="Xem d·ªØ li·ªáu">
              <span class="btn-icon">üìú</span>
              <span class="btn-text">Gia Ph·∫£</span>
            </button>
            <button id="exportYaml" class="ritual-btn" title="Xu·∫•t gia ph·∫£">
              <span class="btn-icon">üñãÔ∏è</span>
              <span class="btn-text">Bi√™n Ch√©p</span>
            </button>
          </div>
      </div>
    </div>
  <script>
    {% assign data_file = page.data_file | default: "family_tree_mother" %}
    const initialFamilyData = {{ site.data[data_file] | jsonify }};
    let family;
    
    // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu hi·ªán t·∫°i
    let currentData = JSON.parse(JSON.stringify(initialFamilyData));
    
    // Bi·∫øn ƒë·∫øm ID m·ªõi
    let nextId = Math.max(...initialFamilyData.map(node => node.id)) + 1;

    // ƒê·ªãnh nghƒ©a template m·ªõi k·∫øt h·ª£p Hugo v√† Sriniz v·ªõi gradient
    FamilyTree.templates.myHugo = Object.assign({}, FamilyTree.templates.hugo);

    // Th√™m defs v·ªõi gradient v√† c√°c bi·ªÉu t∆∞·ª£ng
    FamilyTree.templates.myHugo.defs = `
      <defs>
        <!-- Gradient cho nam -->
        <linearGradient id="maleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#d4a76a;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#8c5e2d;stop-opacity:1" />
        </linearGradient>
        
        <!-- Gradient cho n·ªØ -->
        <linearGradient id="femaleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#c9a0dc;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#8a4baf;stop-opacity:1" />
        </linearGradient>
        
        <!-- Gradient cho expand icon nam -->
        <linearGradient id="expandMaleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#64B5F6;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#1976D2;stop-opacity:1" />
        </linearGradient>
        
        <!-- Gradient cho expand icon n·ªØ -->
        <linearGradient id="expandFemaleGradient" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#F48FB1;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#D81B60;stop-opacity:1" />
        </linearGradient>
        
        <!-- Pattern g·ªó cho n·ªÅn -->
        <pattern id="woodPattern" patternUnits="userSpaceOnUse" width="100" height="100">
          <rect width="100" height="100" fill="#5D4037"/>
          <path d="M0,0 L100,100 M100,0 L0,100" stroke="#4E342E" stroke-width="1" opacity="0.1"/>
        </pattern>
      </defs>
      
      <g transform="matrix(0.05,0,0,0.05,-13 ,-12)" id="heart">
        <path d="M448,256c0-106-86-192-192-192S64,150,64,256s86,192,192,192S448,362,448,256Z" style="fill:#fff;stroke:red;stroke-miterlimit:10;stroke-width:24px" fill="red"></path>
        <path d="M256,360a16,16,0,0,1-9-2.78c-39.3-26.68-56.32-45-65.7-56.41-20-24.37-29.58-49.4-29.3-76.5.31-31.06,25.22-56.33,55.53-56.33,20.4,0,35,10.63,44.1,20.41a6,6,0,0,0,8.72,0c9.11-9.78,23.7-20.41,44.1-20.41,30.31,0,55.22,25.27,55.53,56.33.28,27.1-9.31,52.13-29.3,76.5-9.38,11.44-26.4,29.73-65.7,56.41A16,16,0,0,1,256,360Z" fill="red"></path>
      </g>
      <g id="sriniz_male_up">
        <circle cx="15" cy="15" r="10" fill="#fff" stroke="#fff" stroke-width="1"></circle>
        ${FamilyTree.icon.ft(15, 15, 'url(#maleGradient)', 7.5, 7.5)}
      </g>
      <g id="sriniz_female_up">
        <circle cx="15" cy="15" r="10" fill="#fff" stroke="#fff" stroke-width="1"></circle>
        ${FamilyTree.icon.ft(15, 15, 'url(#femaleGradient)', 7.5, 7.5)}
      </g>`;

    // ƒê·ªãnh nghƒ©a n√∫t expand/collapse v·ªõi gradient
    const expandIconMale =
      '<circle cx="-10" cy="50" r="10" fill="url(#expandMaleGradient)" stroke="#fff" stroke-width="1"><title>Expand</title></circle>' +
      '<line x1="-17" y1="50" x2="-3" y2="50" stroke-width="1" stroke="#fff"></line>' +
      '<line x1="-10" y1="43" x2="-10" y2="57" stroke-width="1" stroke="#fff"></line>';

    const expandIconFemale =
      '<circle cx="-10" cy="50" r="10" fill="url(#expandMaleGradient)" stroke="#fff" stroke-width="1"><title>Expand</title></circle>' +
      '<line x1="-17" y1="50" x2="-3" y2="50" stroke-width="1" stroke="#fff"></line>' +
      '<line x1="-10" y1="43" x2="-10" y2="57" stroke-width="1" stroke="#fff"></line>';

    // Template cho nam v·ªõi gradient
    FamilyTree.templates.myHugo_male = Object.assign({}, FamilyTree.templates.myHugo);
    FamilyTree.templates.myHugo_male.node = '<rect x="0" y="0" height="{h}" width="{w}" fill="url(#maleGradient)" stroke="#aeaeae" stroke-width="1" rx="5" ry="5"></rect>';
    FamilyTree.templates.myHugo_male.plus = expandIconMale;

    // Template cho n·ªØ v·ªõi gradient
    FamilyTree.templates.myHugo_female = Object.assign({}, FamilyTree.templates.myHugo);
    FamilyTree.templates.myHugo_female.node = '<rect x="0" y="0" height="{h}" width="{w}" fill="url(#femaleGradient)" stroke="#aeaeae" stroke-width="1" rx="5" ry="5"></rect>';
    FamilyTree.templates.myHugo_female.plus = expandIconFemale;

    // Th√™m bi·ªÉu t∆∞·ª£ng gi·ªõi t√≠nh tr√™n c√πng
    FamilyTree.templates.myHugo_male.up = '<use x="195" y="0" xlink:href="#sriniz_male_up"></use>';
    FamilyTree.templates.myHugo_female.up = '<use x="195" y="0" xlink:href="#sriniz_female_up"></use>';

    // Pointer t·ª´ Sriniz v·ªõi gradient
    FamilyTree.templates.myHugo.pointer =
      '<g data-pointer="pointer" transform="matrix(0,0,0,0,80,80)">><g transform="matrix(0.3,0,0,0.3,-17,-17)">' +
      '<polygon fill="url(#maleGradient)" points="53.004,173.004 53.004,66.996 0,120" />' +
      '<polygon fill="url(#maleGradient)" points="186.996,66.996 186.996,173.004 240,120" />' +
      '<polygon fill="url(#femaleGradient)" points="66.996,53.004 173.004,53.004 120,0" />' +
      '<polygon fill="url(#femaleGradient)" points="120,240 173.004,186.996 66.996,186.996" />' +
      '<circle fill="red" cx="120" cy="120" r="30" />' +
      '</g></g>';

    function getOptions(){
      const searchParams = new URLSearchParams(window.location.search);
      var fit = searchParams.get('fit');
      var enableSearch = false;
      var scaleInitial = 1;
      if (fit == 'yes'){
        enableSearch = false;
        scaleInitial = FamilyTree.match.boundary;
      }
      return {enableSearch, scaleInitial};
    }

    // H√†m t√¨m node trong currentData theo ID
    function findNodeById(id) {
      return currentData.find(node => node.id == id);
    }

    // H√†m c·∫≠p nh·∫≠t node trong currentData
    function updateNodeInCurrentData(nodeData) {
      const index = currentData.findIndex(node => node.id == nodeData.id);
      if (index !== -1) {
        // C·∫≠p nh·∫≠t node ƒë√£ t·ªìn t·∫°i
        currentData[index] = { ...currentData[index], ...nodeData };
      } else {
        // Th√™m node m·ªõi
        currentData.push(nodeData);
      }
    }

    // H√†m x·ª≠ l√Ω khi form edit ƒë∆∞·ª£c submit
    function handleEditFormSubmit(nodeData) {
      console.log('Edit form submitted:', nodeData);
      
      // Chu·∫©n h√≥a d·ªØ li·ªáu
      const normalizedData = {
        id: nodeData.id,
        name: nodeData.name || "",
        role: nodeData.role || "",
        born: nodeData.born || "",
        died: nodeData.died || "",
        img: nodeData.photo || nodeData.img || (nodeData.gender === 'female' ? "/assets/images/family/female.svg" : "/assets/images/family/male.svg"),
        gender: nodeData.gender || "male",
        pids: nodeData.pids || [],
        mid: nodeData.mid,
        fid: nodeData.fid
      };

      updateNodeInCurrentData(normalizedData);
      console.log('Current data updated:', currentData);
    }

    // H√†m x·ª≠ l√Ω khi th√™m node m·ªõi
    function handleAddNode(parentId, nodeData) {
      const newNode = {
        id: nextId++,
        name: nodeData.name || "",
        role: nodeData.role || "",
        born: nodeData.born || "",
        died: nodeData.died || "",
        img: nodeData.photo || (nodeData.gender === 'female' ? "/assets/images/family/female.svg" : "/assets/images/family/male.svg"),
        gender: nodeData.gender || "male",
        pids: nodeData.pids || []
      };

      // Thi·∫øt l·∫≠p quan h·ªá cha m·∫π
      if (parentId) {
        const parent = findNodeById(parentId);
        if (parent) {
          if (parent.gender === 'male') {
            newNode.fid = parentId;
            if (parent.pids && parent.pids.length > 0) {
              newNode.mid = parent.pids[0];
            }
          } else {
            newNode.mid = parentId;
            if (parent.pids && parent.pids.length > 0) {
              newNode.fid = parent.pids[0];
            }
          }
        }
      }

      currentData.push(newNode);
      console.log('New node added:', newNode);
      return newNode.id;
    }

    // H√†m chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang YAML format
    function convertToYamlFormat(nodes) {
      if (!nodes || !Array.isArray(nodes)) {
        console.error('Nodes data is invalid:', nodes);
        return [];
      }
      
      return nodes.map(node => {
        const yamlNode = {
          id: node.id
        };

        // Th√™m c√°c tr∆∞·ªùng c√≥ ƒëi·ªÅu ki·ªán
        if (node.pids && node.pids.length > 0) yamlNode.pids = node.pids;
        if (node.mid) yamlNode.mid = node.mid;
        if (node.fid) yamlNode.fid = node.fid;
        
        yamlNode.name = node.name || "";
        yamlNode.role = node.role || "";
        yamlNode.born = node.born || "";
        yamlNode.died = node.died || "";
        yamlNode.photo = node.photo || (node.gender === 'female' ? "/assets/images/family/female.svg" : "/assets/images/family/male.svg");
        yamlNode.gender = node.gender || "male";

        return yamlNode;
      }).sort((a, b) => (a.id - b.id));
    }

    // H√†m ƒë·ªãnh d·∫°ng YAML
    function formatYAML(data) {
      if (!data || !Array.isArray(data)) {
        return "# No data available";
      }
      
      let yaml = "# Family Tree Data\n# Generated: " + new Date().toLocaleString('vi-VN') + "\n\n";
      let currentGeneration = -1;
      
      data.forEach((node, index) => {
        let generation = 0;
        yaml += `- id: ${node.id}\n`;
        
        if (node.pids && node.pids.length > 0) {
          yaml += `  pids: [${node.pids.join(', ')}]\n`;
        }
        if (node.mid) yaml += `  mid: ${node.mid}\n`;
        if (node.fid) yaml += `  fid: ${node.fid}\n`;
        
        yaml += `  name: "${node.name}"\n`;
        if (node.role && node.role !== "") yaml += `  role: "${node.role}"\n`;
        yaml += `  born: "${node.born}"\n`;
        yaml += `  died: "${node.died}"\n`;
        yaml += `  photo: "${node.photo}"\n`;
        yaml += `  gender: "${node.gender}"\n`;
        
        if (index < data.length - 1) yaml += "\n";
      });
      
      return yaml;
    }

    // H√†m download file
    function downloadFile(content, filename, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // H√†m export YAML
    function exportToYaml() {
      try {
        const yamlFormatData = convertToYamlFormat(currentData);
        const yamlContent = formatYAML(yamlFormatData);
        
        const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
        const filename = `family_tree_export_${timestamp}.yml`;
        
        downloadFile(yamlContent, filename, 'text/yaml');
        return true;
      } catch (error) {
        console.error('Export error:', error);
        throw error;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // X·ª≠ l√Ω intro
      const introOverlay = document.getElementById('introOverlay');
      const enterButton = document.getElementById('enterButton');
      const ancestralAltar = document.getElementById('ancestralAltar');
      
      enterButton.addEventListener('click', function() {
        // Hi·ªáu ·ª©ng fade out cho intro
        introOverlay.classList.add('intro-fade-out');
        
        // Hi·ªÉn th·ªã giao di·ªán ch√≠nh sau khi intro k·∫øt th√∫c
        setTimeout(() => {
          introOverlay.style.display = 'none';
          ancestralAltar.classList.add('fade-in');
          
          // Kh·ªüi t·∫°o c√¢y gia ph·∫£
          initializeFamilyTree();
          
        }, 1000);
      });
      
      function initializeFamilyTree() {
        var options = getOptions();

        family = new FamilyTree(document.getElementById('tree'), {
          orientation: FamilyTree.orientation.left,
          mouseScrool: FamilyTree.action.zoom,
          scaleInitial: 0.7,
          mode: 'dark',
          template: 'myHugo', // S·ª≠ d·ª•ng template m·ªõi
          enableSearch: options.enableSearch,
          nodeMenu: {
            edit: { text: 'Ch·ªânh s·ª≠a' },
            details: { text: 'Chi ti·∫øt' },
          },
          nodeTreeMenu: true,
          nodeBinding: {
            field_0: 'name',
            field_1: 'born',
            img_0: 'photo'
          },
          editForm: {
            titleBinding: "name",
            photoBinding: "photo",
            addMoreBtn: 'Th√™m ph·∫ßn t·ª≠',
            addMore: 'Th√™m nhi·ªÅu ph·∫ßn t·ª≠ h∆°n',
            addMoreFieldName: 'T√™n ph·∫ßn t·ª≠',
            generateElementsFromFields: true,
            elements: [
              { type: 'textbox', label: 'H·ªç v√† T√™n', binding: 'name' },
              { type: 'textbox', label: 'Vai tr√≤', binding: 'role' },
              { type: 'textbox', label: 'Email', binding: 'email' },
              [
                { type: 'textbox', label: 'S·ªë ƒëi·ªán tho·∫°i', binding: 'phone' },
                { type: 'textbox', label: 'Ng√†y sinh', binding: 'born' },
                { type: 'textbox', label: 'Ng√†y m·∫•t', binding: 'died' }
              ],
              [
                { 
                  type: 'select', 
                  options: [
                    { value: 'male', text: 'Nam' }, 
                    { value: 'female', text: 'N·ªØ' }
                  ], 
                  label: 'Gi·ªõi t√≠nh', 
                  binding: 'gender' 
                },
                { type: 'textbox', label: 'Th√†nh ph·ªë', binding: 'city' },
              ],
              { type: 'textbox', label: 'URL ·∫¢nh', binding: 'photo', btn: 'T·∫£i l√™n' },
            ]
          },
          toolbar: {
            fullScreen: true,
            zoom: true,
            fit: true,
            expandAll: true,
          },
        });

        // X·ª≠ l√Ω s·ª± ki·ªán render-link ƒë·ªÉ th√™m bi·ªÉu t∆∞·ª£ng tr√°i tim
        family.on('render-link', function (sender, args) {
          if (args.cnode.ppid != undefined)
            args.html += '<use data-ctrl-ec-id="' + args.node.id + '" xlink:href="#heart" x="' + (args.p.xa) + '" y="' + (args.p.ya) + '"/>';
          if (args.cnode.isPartner && args.node.partnerSeparation == 30)
            args.html += '<use data-ctrl-ec-id="' + args.node.id + '" xlink:href="#heart" x="' + (args.p.xb) + '" y="' + (args.p.yb) + '"/>';
        });

        // X·ª≠ l√Ω s·ª± ki·ªán khi form edit ƒë∆∞·ª£c ƒë√≥ng (sau khi submit)
        family.on('edit-form-close', function (sender, args) {
          console.log('Edit form closed:', args);
          if (args && args.data) {
            handleEditFormSubmit(args.data);
          }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán khi node ƒë∆∞·ª£c th√™m
        family.on('add-node', function (sender, args) {
          console.log('Node added:', args);
          if (args && args.data) {
            const newId = handleAddNode(args.parentId, args.data);
            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu ƒë·ªÉ FamilyTree nh·∫≠n node m·ªõi
            setTimeout(() => {
              family.load(currentData);
            }, 100);
          }
        });

        // X·ª≠ l√Ω ng√†y th√°ng nh∆∞ text - kh√¥ng parse th√†nh Date
        family.on('field', function (sender, args) {
          if ((args.name == 'born' || args.name == 'died') && args.value) {
            // Ch·ªâ hi·ªÉn th·ªã gi√° tr·ªã text nguy√™n g·ªëc, kh√¥ng x·ª≠ l√Ω g√¨ th√™m
            args.value = args.value;
          }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán export YAML
        document.getElementById('exportYaml').addEventListener('click', function() {
          const btn = this;
          try {
            btn.textContent = 'ƒêang Export...';
            btn.disabled = true;
            
            const success = exportToYaml();
            
            if (success) {
              btn.textContent = 'ƒê√£ Export!';
              setTimeout(() => {
                btn.textContent = 'Export YAML';
                btn.disabled = false;
              }, 2000);
            } else {
              btn.textContent = 'Export YAML';
              btn.disabled = false;
            }
            
          } catch (error) {
            console.error('Export error:', error);
            alert('C√≥ l·ªói x·∫£y ra khi export d·ªØ li·ªáu: ' + error.message);
            btn.textContent = 'Export YAML';
            btn.disabled = false;
          }
        });

        // X·ª≠ l√Ω s·ª± ki·ªán debug
        document.getElementById('debugBtn').addEventListener('click', function() {
          console.log('=== DEBUG INFORMATION ===');
          console.log('Current data:', currentData);
          console.log('Next ID:', nextId);
          console.log('Family instance:', family);
          
          // Ki·ªÉm tra c√°c node m·ªõi ƒë∆∞·ª£c th√™m
          const newNodes = currentData.filter(node => node.id >= nextId - 10);
          console.log('Recently added nodes:', newNodes);
          
          alert('Check console for debug information (F12)');
        });

        family.onInit(() => {
          //family.collapse(11, [12,14,16,21,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,60,61,62,63,64,65]);
          family.center(17);
        });

        // Load d·ªØ li·ªáu ban ƒë·∫ßu
        family.load(currentData);

      }
    });
  </script>
</body>
</html>